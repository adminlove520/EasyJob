# 本地测试第三方登录指南

本文档提供在本地开发环境中测试钉钉和GitHub第三方登录的完整步骤，包括内网穿透配置。

## 为什么需要内网穿透？

第三方登录服务（如钉钉、GitHub）需要将用户重定向回应用，但它们只能访问公网可访问的URL，无法直接访问您的本地开发服务器(`http://localhost:3000`)。内网穿透工具可以将您的本地服务映射到公网，使第三方登录回调能够正常工作。

## 一、前期准备

### 1. 配置后端环境变量

打开 `backend/.env` 文件，更新以下参数：

#### 钉钉配置
```
# 钉钉OAuth Configuration
DINGTALK_CLIENT_ID=你的钉钉应用APPID
DINGTALK_CLIENT_SECRET=你的钉钉应用APPSECRET
DINGTALK_REDIRECT_URI=http://localhost:3000/auth/dingtalk/callback
```

#### GitHub配置
```
# GitHub OAuth Configuration
GITHUB_CLIENT_ID=你的GitHub OAuth应用CLIENT_ID
GITHUB_CLIENT_SECRET=你的GitHub OAuth应用CLIENT_SECRET
GITHUB_REDIRECT_URI=http://localhost:3000/auth/github/callback
```

### 2. 获取第三方应用凭证

#### 钉钉应用创建
1. 访问 [钉钉开发者平台](https://open-dev.dingtalk.com/)
2. 登录并创建一个新的第三方网页应用
3. 在应用设置中获取 `AppID` 和 `AppSecret`
4. 在回调地址配置中添加：`http://localhost:3000/auth/dingtalk/callback`

#### GitHub OAuth应用创建
1. 访问 [GitHub Developer Settings](https://github.com/settings/developers)
2. 创建一个新的OAuth应用
3. 设置以下参数：
   - Application name: 任意名称（如：Chat Resume Dev）
   - Homepage URL: `http://localhost:3000`
   - Authorization callback URL: `http://localhost:3000/auth/github/callback`
4. 创建后获取 `Client ID` 和 `Client Secret`

## 二、配置内网穿透

### 1. 使用ngrok进行内网穿透

ngrok是一个流行的内网穿透工具，可以将本地端口映射到公网：

1. 下载并安装ngrok：访问 [ngrok官网](https://ngrok.com/) 下载并安装
2. 注册ngrok账号并获取授权令牌
3. 运行以下命令将本地3000端口映射到公网：

```bash
# 将本地3000端口(前端)映射到公网
ngrok http 3000

# 将本地8000端口(后端)映射到公网
# 注意：需要在另一个终端窗口运行
ngrok http 8000
```

运行后，ngrok会为您生成类似这样的公网URL：
- 前端: `https://abcd-123-45-67-89.ngrok-free.app`
- 后端: `https://efgh-98-76-54-32.ngrok-free.app`

### 2. 更新环境变量配置

获得ngrok提供的公网URL后，需要更新 `.env` 文件中的回调地址：

```
# 钉钉OAuth Configuration
DINGTALK_REDIRECT_URI=https://abcd-123-45-67-89.ngrok-free.app/auth/dingtalk/callback

# GitHub OAuth Configuration
GITHUB_REDIRECT_URI=https://abcd-123-45-67-89.ngrok-free.app/auth/github/callback
```

## 三、启动前后端服务

### 1. 启动后端服务

```bash
# 在backend目录下执行
pip install -r requirements.txt
python -m app.main
```

### 2. 启动前端服务

```bash
# 在frontend目录下执行
npm install
npm run dev
```

前端服务将在 `http://localhost:3000` 运行，后端服务将在 `http://localhost:8000` 运行。

## 四、更新第三方应用配置

### 1. 更新钉钉应用配置
1. 登录 [钉钉开发者平台](https://open-dev.dingtalk.com/)
2. 进入您的应用设置
3. 更新回调地址为ngrok提供的前端公网URL：
   - 回调地址: `https://abcd-123-45-67-89.ngrok-free.app/auth/dingtalk/callback`

### 2. 更新GitHub应用配置
1. 登录 [GitHub Developer Settings](https://github.com/settings/developers)
2. 进入您的OAuth应用设置
3. 更新以下参数：
   - Homepage URL: `https://abcd-123-45-67-89.ngrok-free.app`
   - Authorization callback URL: `https://abcd-123-45-67-89.ngrok-free.app/auth/github/callback`

## 五、测试流程

### 1. 测试钉钉登录
1. 访问ngrok提供的前端公网URL + `/login`
   例如：`https://abcd-123-45-67-89.ngrok-free.app/login`
2. 点击「钉钉」登录按钮
3. 系统将重定向到钉钉授权页面
4. 使用钉钉账号授权登录
5. 授权成功后，将重定向回应用并完成登录

### 2. 测试GitHub登录
1. 访问ngrok提供的前端公网URL + `/login`
   例如：`https://abcd-123-45-67-89.ngrok-free.app/login`
2. 点击「GitHub」登录按钮
3. 系统将重定向到GitHub授权页面
4. 使用GitHub账号授权登录
5. 授权成功后，将重定向回应用并完成登录

## 四、常见问题排查

### 1. 404错误
- 确保后端服务正常运行在 `http://localhost:8000`
- 检查登录按钮链接是否正确指向后端API
- 验证API路由是否正确配置

### 2. 授权回调失败
- 检查第三方应用配置的回调地址是否与 `.env` 文件中的 `REDIRECT_URI` 一致
- 确认使用的是ngrok提供的公网URL而不是localhost
- 每次ngrok重启后，需要更新所有相关配置中的URL

### 3. ngrok隧道问题
- 如果ngrok隧道过期或断开，请重新启动ngrok
- 更新所有相关配置中的URL（环境变量和第三方应用配置）

### 3. CORS错误
- 检查后端 `.env` 文件中的 `BACKEND_CORS_ORIGINS` 是否包含 `http://localhost:3000`

### 4. 应用凭证错误
- 验证 `.env` 文件中的应用ID和密钥是否与第三方平台上的配置一致
- 确保没有多余的空格或特殊字符

## 五、开发提示

### 使用环境变量管理API地址
为了更灵活地切换开发和生产环境，建议在前端使用环境变量管理API地址：

```javascript
// 在前端代码中使用环境变量
const apiBaseUrl = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000';
const loginUrl = `${apiBaseUrl}/api/v1/auth/dingtalk/login`;
```

### 更新前端代码中的登录按钮链接

将登录按钮的硬编码链接改为使用环境变量或动态构建：

```javascript
// 修改login/page.tsx中的登录按钮链接
const apiBaseUrl = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000';

// 然后在按钮中使用
onClick={() => window.location.href = `${apiBaseUrl}/api/v1/auth/dingtalk/login`}
```

这样可以避免在代码中硬编码API地址，便于不同环境间的切换。

### 调试技巧
1. 在浏览器控制台查看网络请求和响应，帮助排查登录流程中的问题
2. 在后端添加日志记录，跟踪OAuth流程的执行情况
3. 使用ngrok的Web界面（通常是 http://127.0.0.1:4040）查看请求详情
4. 检查第三方平台的开发者工具或日志，了解授权失败的具体原因

### 常见替代内网穿透方案

如果不想使用ngrok，也可以考虑以下替代方案：

1. **Frp** - 开源的内网穿透工具
2. **CloudFlare Tunnel** - 免费且安全的内网穿透服务
3. **花生壳** - 国内常用的内网穿透工具
4. **localtunnel** - 简单的命令行内网穿透工具